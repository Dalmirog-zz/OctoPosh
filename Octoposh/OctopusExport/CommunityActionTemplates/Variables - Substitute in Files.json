{
  "$type": "Octopus.Core.Model.Projects.CommunityActionTemplate, Octopus.Core",
  "Id": "CommunityActionTemplates-173",
  "Name": "Variables - Substitute in Files",
  "ExternalId": "a3078bc0-0615-4220-84e8-bb1f271a90f9",
  "Description": "Replaces variables in a file(s) with their values from OctopusParameters",
  "Version": 8,
  "ActionType": "Octopus.Script",
  "Author": "worknate",
  "Website": "https://library.octopus.com/step-templates/a3078bc0-0615-4220-84e8-bb1f271a90f9",
  "HistoryUrl": "https://github.com/OctopusDeploy/Library/commits/master/step-templates/variables-substitute-in-files.json",
  "Category": "Octopus",
  "Properties": {
    "Octopus.Action.Script.ScriptBody": "$ErrorActionPreference = \"Stop\"\n\nfunction Resolve-OctopusVariablesInTemplate{\n<#\n.SYNOPSIS\n\tResolves Octopus variables in files with their values from a OctopusParameters\n\n.DESCRIPTION\n\tLooks for files using Get-ChildItem and in each of the files replaces ${Variable} with the value from $OctopusParameters.\n\tFiles are written back using UTF-8.\n\tRequires PowerShell 3.0 or higher.\n\n.PARAMETER Path\n\tPassed to Get-ChildItem to find the files you want to process\n\n.PARAMETER Filter\n\tPassed to Get-ChildItem to find the files you want to process\n\n.PARAMETER Include\n\tPassed to Get-ChildItem to find the files you want to process\n\n.PARAMETER Exclude\n\tPassed to Get-ChildItem to find the files you want to process\n\t\n.PARAMETER Recurse\n\tPassed to Get-ChildItem to find the files you want to process\n\n#>\n\tParam(\n\t\t[string]$Path,\n\t\t[string]$Filter = \"*.config\",\n\t\t[string[]]$Include,\n\t\t[string[]]$Exclude,\n\t\t[switch]$Recurse\n\t)\n\t\n\tif (-not $OctopusParameters) { throw \"No OctopusParameters found\" }\n\t\n\tWrite-Output \"PowerShell version...\"\n\tWrite-Output $PSVersionTable\n\tWrite-Output \"Path = $Path\"\n\t\n\tWrite-Output \"Getting target files...\"\n\t$TargetFiles = Get-ChildItem -File -Path $Path -Filter $Filter -Include $Include -Exclude $Exclude -Recurse:$Recurse\n\tif ($TargetFiles.Count -eq 0) {\n\t\tWrite-Warning \"`tDid not find any files to process!\"\n\t} else {\n\t\tWrite-Output \"`tFound $($TargetFiles.Count) file(s)\"\n\t}\n\t\n\t\n\tif (($env:TentacleVersion) -and ([version]$env:TentacleVersion -ge [version]\"3.0.0.0\")){\n\t\t# This is a new version (>3.0) - use Octostache\n\t\tWrite-Output \"Will use Octostache.dll (TentacleVersion $env:TentacleVersion)\"\n\t\tforeach($File in $TargetFiles){\n\t\t\tResolve-VariablesUsingOctostashe $File.FullName\n\t\t}\n\t} else {\n\t\t# If $env:TentacleVersion is not present we assume the Tentacle is an old version (<3.0).\n\t\tWrite-Output \"Will use Octopus.Platform.dll (TentacleVersion $env:TentacleVersion)\"\n\t\tforeach($File in $TargetFiles){\n\t\t\tResolve-VariablesUsingOctopusPlatformDll ($File.FullName) ($File.FullName)\n\t\t}\n\t}\n}\n\n#Export-ModuleMember -Function Resolve-OctopusVariablesInTemplate\n\nfunction Resolve-VariablesUsingOctostashe{\n\tParam(\n\t\t[string]$TemplateFile\n\t)\n\t\n\tWrite-Output \"Looking for Octostache.dll...\"\n\t# Hack-around until $OctopusParameters['Octopus.Tentacle.Agent.ProgramDirectoryPath'] is fixed\n\t$CalamariPath = $OctopusParameters['env:TentacleHome'] + \"\\Calamari\"\n\t$LatestInstalledCalamari = (Get-ChildItem $CalamariPath | ? { $_.PSIsContainer } | % { [System.Version]$_.Name } | Sort -Descending)[0].ToString()\n\tWrite-Output \"Loading from $CalamariPath\\$LatestInstalledCalamari\\Octostache.dll\"\n\tAdd-Type -Path \"$CalamariPath\\$LatestInstalledCalamari\\Octostache.dll\"\n\t\n\tWrite-Output \"Loading template file $TemplateFile...\"\n\t$TemplateContent = Get-Content -Raw $TemplateFile\n\tWrite-Output \"`tRead $($TemplateContent.Length) bytes\"\n\t\n\t$Dictionary = New-Object -TypeName Octostache.VariableDictionary\n\t\n\t# Load the hastable into the dictionary\n\tWrite-Output \"Loading `$OctopusParameters...\"\n\tforeach ($Variable in $OctopusParameters.GetEnumerator()) {\n\t\tWrite-Verbose \"#{$($Variable.Key)} = $($Variable.Value)\"\n\t\t$Dictionary.Set($Variable.Key, $Variable.Value)\n\t}\n\t\n\tWrite-Output \"Resolving variables...\"\n\t$EvaluatedTemplate = $Dictionary.Evaluate($TemplateContent)\n\t\n\tWrite-Output \"Writing the resolved template to $($TemplateFile)\"\n\t$EvaluatedTemplate | Out-File $TemplateFile -Force\t-Encoding UTF8\n\tWrite-Output \"Done!\"\n}\n\n\n\nfunction Resolve-VariablesUsingOctopusPlatformDll{\n\tParam(\n\t\t[string]$templateFile,\n\t\t[string]$outputFile\n\t)\n\tAdd-Type -Path ($OctopusParameters['Octopus.Tentacle.Agent.ProgramDirectoryPath'] + \"\\Octopus.Platform.dll\")\n\t\n\tWrite-Output \"Loading template file $templateFile...\"\n     \n    $contents = [System.IO.File]::ReadAllText($templateFile)\n\t\n\t$template = $null\n    $parseErr = $null\n    \n    if (-not [Octopus.Platform.Variables.Templates.Parser.TemplateParser]::TryParseTemplate($contents, [ref] $template, [ref] $parseErr))\n    {\n        throw \"The file contents could not be parsed as a valid Octopus template: $parseErr\"\n    }\n    \n    Write-Output \"Binding variables...\"\n    \n    $binding = [Octopus.Platform.Variables.Templates.Binder.PropertyListBinder]::CreateFrom($OctopusParameters)\n    \n    $newContents = New-Object System.Text.StringBuilder\n    $writer = New-Object System.IO.StringWriter $newContents\n    \n    Write-Output \"Evaluating template...\"\n    \n    [Octopus.Platform.Variables.Templates.Evaluator.TemplateEvaluator]::Evaluate($template, $binding, $writer)\n    \n    $writer.Dispose()\n    \n    Write-Output \"Writing result to $outputFile...\"\n    \n    [System.IO.File]::WriteAllText($outputFile, $newContents.ToString())\n}\n\n#---- Auto generated bootstrap by OctopusStepGenerator\n$FunctionParameters = @{}\nif($OctopusParameters['Path'] -ne $null){$FunctionParameters.Add('Path', $OctopusParameters['Path'])}\nif($OctopusParameters['Filter'] -ne $null){$FunctionParameters.Add('Filter', $OctopusParameters['Filter'])}\nif($OctopusParameters['Include'] -ne $null){$FunctionParameters.Add('Include', $($OctopusParameters['Include'] -split \"`n\"))}\nif($OctopusParameters['Exclude'] -ne $null){$FunctionParameters.Add('Exclude', $($OctopusParameters['Exclude'] -split \"`n\"))}\nif($OctopusParameters['Recurse'] -ne $null){$FunctionParameters.Add('Recurse', [System.Convert]::ToBoolean($OctopusParameters['Recurse']))}\nResolve-OctopusVariablesInTemplate @FunctionParameters\n",
    "Octopus.Action.Script.Syntax": "PowerShell",
    "Octopus.Action.Script.ScriptSource": "Inline",
    "Octopus.Action.Script.ScriptFileName": "",
    "Octopus.Action.Package.NuGetFeedId": "",
    "Octopus.Action.Package.NuGetPackageId": ""
  },
  "Parameters": [
    {
      "Id": null,
      "Name": "Path",
      "Label": "Path",
      "HelpText": "Passed to Get-ChildItem to find the files you want to process",
      "DefaultValue": "",
      "DisplaySettings": {
        "Octopus.ControlType": "SingleLineText"
      }
    },
    {
      "Id": null,
      "Name": "Filter",
      "Label": "Filter",
      "HelpText": "Passed to Get-ChildItem to find the files you want to process",
      "DefaultValue": "*.config",
      "DisplaySettings": {}
    },
    {
      "Id": null,
      "Name": "Include",
      "Label": "Include",
      "HelpText": "Passed to Get-ChildItem to find the files you want to process",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "MultiLineText"
      }
    },
    {
      "Id": null,
      "Name": "Exclude",
      "Label": "Exclude",
      "HelpText": "Passed to Get-ChildItem to find the files you want to process",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "MultiLineText"
      }
    },
    {
      "Id": null,
      "Name": "Recurse",
      "Label": "Recurse",
      "HelpText": "Passed to Get-ChildItem to find the files you want to process",
      "DefaultValue": null,
      "DisplaySettings": {
        "Octopus.ControlType": "Checkbox"
      }
    }
  ],
  "LogoAttachmentKey": "CommunityActionTemplates-173",
  "LogoAttachmentMimeType": "image/png"
}